{% extends "layout.html" %}

{% block title %}Dashboards de Monitoreo{% endblock %}

{% block body %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-end align-items-center">
      <button class="btn btn-outline-primary btn-sm" onclick="window.location='{{ url_for('index') }}'" title="Volver al Panel Principal">
        <i class="bi bi-arrow-left"></i> Volver al Panel Principal
      </button>
    </div>
  </div>
  <!-- Informaci칩n del nodo seleccionado -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <div class="card border-primary">
        <div class="card-body py-3">
          <h4 class="mb-0 dashboard-title-azul">
            <i class="bi bi-cpu dashboard-icon-azul me-2"></i>
            Nodo: <span class="dashboard-text">{{ nodo.esp_id }}</span> - <span class="dashboard-text-muted">{{ nodo.descripcion }}</span>
          </h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Cabecera de secci칩n -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center mb-2">
        <i class="bi bi-graph-up fs-2 me-2 text-primary"></i>
        <h1 class="h3 mb-0 dashboard-title-azul">Dashboards de Monitoreo</h1>
      </div>
      <p class="dashboard-text-muted">Visualiza los datos de tus dispositivos: tensi칩n, corriente, energ칤a, factor de potencia y frecuencia.</p>
      <div class="alert alert-info mt-3 dashboard-text">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Informaci칩n importante:</strong> Las vistas previas muestran datos de la <strong>칰ltima hora</strong>. 
        Si no ves datos, puede ser porque no se han enviado mediciones en ese per칤odo o porque el dispositivo est치 desconectado.
      </div>
      
      <!-- Leyenda de estados -->
      <div class="d-flex justify-content-end mt-3">
        <div class="d-flex align-items-center gap-3">
          <small class="dashboard-text-muted">Estados:</small>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-success px-2 py-1" style="font-size: 0.75rem;">Activo</span>
            <small class="dashboard-text-muted">Datos en los 칰ltimos 30 min</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-danger px-2 py-1" style="font-size: 0.75rem;">Desconectado</span>
            <small class="dashboard-text-muted">Datos antiguos (>30 min)</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary px-2 py-1" style="font-size: 0.75rem;">Sin datos</span>
            <small class="dashboard-text-muted">Sin datos disponibles</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enlace al an치lisis de consumo individual -->


  <!-- Grid de dashboards -->
  <div class="row" id="dashboardsGrid">
    <!-- Tarjeta Energ칤a (grande, primer rengl칩n) -->
    <div class="col-12 mb-4">
      <div class="card h-100 dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="dashboard-icon me-3">
              <i class="fas fa-bolt-lightning text-danger fa-2x"></i>
            </div>
            <div>
              <h5 class="card-title mb-0 dashboard-title-azul">丘뫮잺 Consumo Energ칠tico</h5>
              <small class="subtitle-section dashboard-text-muted">Gr치fico de energ칤a consumida</small>
            </div>
          </div>
          <div class="dashboard-status">
            <span class="badge" id="estado-energia" style="background:#adb5bd; color:#fff;">
              <i class="fas fa-circle me-1"></i>
              Desconectado
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="dashboard-preview">
            <div class="preview-chart">
              <canvas id="preview-energia" width="600" height="200"></canvas>
            </div>
            <div class="preview-info mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value dashboard-text" id="current-energia">-</div>
                    <div class="metric-label dashboard-text-muted">Actual</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value dashboard-text" id="max-energia">-</div>
                    <div class="metric-label dashboard-text-muted">M치ximo</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value dashboard-text" id="min-energia">-</div>
                    <div class="metric-label dashboard-text-muted">M칤nimo</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted" id="last-update-energia">
              <i class="fas fa-clock me-1"></i>
              칔ltima actualizaci칩n: -
            </small>
            <a href="{{ url_for('nodo_dashboard_magnitud', nodo_id=nodo.nodo_id, magnitud='consumo') }}" class="btn btn-primary btn-sm">
              <i class="bi bi-bar-chart-line me-1"></i>
              Ver Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- Tarjeta Tensi칩n -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100 dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="dashboard-icon me-3">
              <i class="fas fa-bolt text-warning fa-2x"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">游댋 Monitoreo de Tensi칩n</h5>
              <small class="subtitle-section">Gr치fico de tensi칩n a trav칠s del tiempo</small>
            </div>
          </div>
          <div class="dashboard-status">
            <span class="badge" id="estado-tension" style="background:#adb5bd; color:#fff;">
              <i class="fas fa-circle me-1"></i>
              Desconectado
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="dashboard-preview">
            <div class="preview-chart">
              <canvas id="preview-tension" width="400" height="200"></canvas>
            </div>
            <div class="preview-info mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="current-tension">-</div>
                    <div class="metric-label">Actual</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="max-tension">-</div>
                    <div class="metric-label">M치ximo</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="min-tension">-</div>
                    <div class="metric-label">M칤nimo</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted" id="last-update-tension">
              <i class="fas fa-clock me-1"></i>
              칔ltima actualizaci칩n: -
            </small>
            <a href="{{ url_for('nodo_dashboard_magnitud', nodo_id=nodo.nodo_id, magnitud='tension') }}" class="btn btn-primary btn-sm">
              <i class="bi bi-bar-chart-line me-1"></i>
              Ver Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- Tarjeta Corriente -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100 dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="dashboard-icon me-3">
              <i class="fas fa-battery-half text-success fa-2x"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">游댊 Monitoreo de Corriente</h5>
              <small class="subtitle-section">Gr치fico de corriente a trav칠s del tiempo</small>
            </div>
          </div>
          <div class="dashboard-status">
            <span class="badge" id="estado-corriente" style="background:#adb5bd; color:#fff;">
              <i class="fas fa-circle me-1"></i>
              Desconectado
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="dashboard-preview">
            <div class="preview-chart">
              <canvas id="preview-corriente" width="400" height="200"></canvas>
            </div>
            <div class="preview-info mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="current-corriente">-</div>
                    <div class="metric-label">Actual</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="max-corriente">-</div>
                    <div class="metric-label">M치ximo</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="min-corriente">-</div>
                    <div class="metric-label">M칤nimo</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted" id="last-update-corriente">
              <i class="fas fa-clock me-1"></i>
              칔ltima actualizaci칩n: -
            </small>
            <a href="{{ url_for('nodo_dashboard_magnitud', nodo_id=nodo.nodo_id, magnitud='corriente') }}" class="btn btn-primary btn-sm">
              <i class="bi bi-bar-chart-line me-1"></i>
              Ver Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- Tarjeta Factor de Potencia -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100 dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="dashboard-icon me-3">
              <i class="fas fa-bolt text-primary fa-2x"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">游늳 Monitoreo de FP</h5>
              <small class="subtitle-section">Gr치fico de factor de potencia</small>
            </div>
          </div>
          <div class="dashboard-status">
            <span class="badge" id="estado-fp" style="background:#adb5bd; color:#fff;">
              <i class="fas fa-circle me-1"></i>
              Desconectado
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="dashboard-preview">
            <div class="preview-chart">
              <canvas id="preview-fp" width="400" height="200"></canvas>
            </div>
            <div class="preview-info mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="current-fp">-</div>
                    <div class="metric-label">Actual</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="max-fp">-</div>
                    <div class="metric-label">M치ximo</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="min-fp">-</div>
                    <div class="metric-label">M칤nimo</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted" id="last-update-fp">
              <i class="fas fa-clock me-1"></i>
              칔ltima actualizaci칩n: -
            </small>
            <a href="{{ url_for('nodo_dashboard_magnitud', nodo_id=nodo.nodo_id, magnitud='fp') }}" class="btn btn-primary btn-sm">
              <i class="bi bi-bar-chart-line me-1"></i>
              Ver Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- Tarjeta Frecuencia -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100 dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="dashboard-icon me-3">
              <i class="fas fa-wave-square text-info fa-2x"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">游 Monitoreo de Frecuencia</h5>
              <small class="subtitle-section">Gr치fico de frecuencia a trav칠s del tiempo</small>
            </div>
          </div>
          <div class="dashboard-status">
            <span class="badge" id="estado-frecuencia" style="background:#adb5bd; color:#fff;">
              <i class="fas fa-circle me-1"></i>
              Desconectado
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="dashboard-preview">
            <div class="preview-chart">
              <canvas id="preview-frecuencia" width="400" height="200"></canvas>
            </div>
            <div class="preview-info mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="current-frecuencia">-</div>
                    <div class="metric-label">Actual</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="max-frecuencia">-</div>
                    <div class="metric-label">M치ximo</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-preview">
                    <div class="metric-value" id="min-frecuencia">-</div>
                    <div class="metric-label">M칤nimo</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted" id="last-update-frecuencia">
              <i class="fas fa-clock me-1"></i>
              칔ltima actualizaci칩n: -
            </small>
            <a href="{{ url_for('nodo_dashboard_magnitud', nodo_id=nodo.nodo_id, magnitud='frecuencia') }}" class="btn btn-primary btn-sm">
              <i class="bi bi-bar-chart-line me-1"></i>
              Ver Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dispositivoSeleccionado = '{{ nodo.esp_id }}';
const nodoId = {{ nodo.nodo_id }};
console.log('DASHBOARDS INIT', { nodoId, dispositivoSeleccionado });

function getChartColors() {
  const isDark = document.body.classList.contains('dark-theme') || document.documentElement.getAttribute('data-theme') === 'dark';
  return {
    axis: isDark ? '#f1f5f9' : '#374151',
    grid: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(30,64,175,0.08)'
  };
}
function updateAllChartsTheme() {
  if (window.Chart && Chart.instances) {
    Object.values(Chart.instances).forEach(chart => {
      const chartColors = getChartColors();
      if (chart.options.scales) {
        if (chart.options.scales.x) {
          chart.options.scales.x.ticks.color = chartColors.axis;
          chart.options.scales.x.grid.color = chartColors.grid;
        }
        if (chart.options.scales.y) {
          chart.options.scales.y.ticks.color = chartColors.axis;
          chart.options.scales.y.grid.color = chartColors.grid;
        }
        if (chart.options.scales.y1) {
          chart.options.scales.y1.ticks.color = chartColors.axis;
          chart.options.scales.y1.grid.color = chartColors.grid;
        }
      }
      chart.update();
    });
  }
}

// --- FIX: themeToggle event listener solo si existe ---
var themeToggle = document.getElementById('themeToggle');
if (themeToggle) {
  themeToggle.addEventListener('click', function() {
    setTimeout(updateAllChartsTheme, 300);
  });
}

// ---------------------- JS de estado de dispositivos ----------------------
function updateDeviceStatus(magnitud, hasData, lastUpdate) {
  try {
    const statusElement = document.getElementById(`estado-${magnitud}`);
    const lastUpdateElement = document.getElementById(`last-update-${magnitud}`);
    
    if (hasData && lastUpdate) {
      // Verificar si el 칰ltimo dato fue en los 칰ltimos 30 minutos
      const lastUpdateTime = new Date(lastUpdate);
      const now = new Date();
      const timeDiff = now - lastUpdateTime;
      const thirtyMinutes = 30 * 60 * 1000; // 30 minutos en milisegundos
      
      if (timeDiff <= thirtyMinutes) {
        // Activo - datos recientes
        statusElement.textContent = 'Activo';
        statusElement.style.background = '#28a745'; // Verde
        statusElement.style.color = '#fff';
      } else {
        // Desconectado - datos antiguos
        statusElement.textContent = 'Desconectado';
        statusElement.style.background = '#dc3545'; // Rojo
        statusElement.style.color = '#fff';
      }
      
      // Formatear fecha y hora del 칰ltimo dato
      const formattedDate = lastUpdateTime.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      const formattedTime = lastUpdateTime.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      lastUpdateElement.innerHTML = `
        <i class="fas fa-clock me-1"></i>
        칔ltima actualizaci칩n: ${formattedDate} ${formattedTime}
      `;
    } else {
      // Sin datos
      statusElement.textContent = 'Sin datos';
      statusElement.style.background = '#6c757d'; // Gris
      statusElement.style.color = '#fff';
      
      lastUpdateElement.innerHTML = `
        <i class="fas fa-clock me-1"></i>
        칔ltima actualizaci칩n: Sin datos
      `;
    }
  } catch (error) {
    console.error(`Error al actualizar el estado de ${magnitud}:`, error);
  }
}

// ---------------------- JS de actualizaci칩n de datos ----------------------
async function updateData(espId) {
  try {
    // Obtener datos reales de la API para cada magnitud
    const magnitudes = ['consumo', 'tension', 'corriente', 'fp', 'frecuencia'];
    const data = {};
    
    // Obtener datos para cada magnitud
    for (const magnitud of magnitudes) {
      try {
        const response = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/${magnitud}?rango=60`);
        const result = await response.json();
        data[magnitud] = result.datos || [];
      } catch (error) {
        console.error(`Error obteniendo datos de ${magnitud}:`, error);
        data[magnitud] = [];
      }
    }

    // Actualizar datos de la tarjeta de consumo
    const consumoData = data.consumo;
    if (consumoData && consumoData.length > 0) {
      const labels = consumoData.map(d => d.tiempo);
      const valores = consumoData.map(d => d.valor);
      
      const consumoChart = new Chart(document.getElementById('preview-energia').getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Consumo (kWh)',
            data: valores,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.1)',
            tension: 0.35,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              title: { display: true, text: 'Consumo (kWh)' },
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            },
            x: {
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            }
          }
        }
      });
      document.getElementById('current-energia').textContent = valores[valores.length - 1].toFixed(2);
      document.getElementById('max-energia').textContent = Math.max(...valores).toFixed(2);
      document.getElementById('min-energia').textContent = Math.min(...valores).toFixed(2);
      
      // Actualizar estado del dispositivo para consumo
      try {
        const response = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/consumo?rango=30`);
        const result = await response.json();
        // Si hay datos en los 칰ltimos 30 minutos, est치 activo
        if (result.datos && result.datos.length > 0) {
          updateDeviceStatus('energia', true, result.ultima_fecha);
        } else {
          // Verificar si hay datos m치s antiguos
          const response24h = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/consumo?rango=1440`);
          const result24h = await response24h.json();
          if (result24h.datos && result24h.datos.length > 0) {
            updateDeviceStatus('energia', true, result24h.ultima_fecha);
          } else {
            updateDeviceStatus('energia', false, null);
          }
        }
      } catch (error) {
        console.error(`Error obteniendo fecha de consumo:`, error);
        updateDeviceStatus('energia', false, null);
      }
    } else {
      document.getElementById('preview-energia').innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
          <h6 class="text-warning">Sin datos en la 칰ltima hora</h6>
          <p class="text-muted mb-2">No se han recibido mediciones de consumo energ칠tico en la 칰ltima hora.</p>
          <small class="text-muted">Verifica que el dispositivo est칠 conectado y enviando datos.</small>
        </div>`;
      document.getElementById('current-energia').textContent = '-';
      document.getElementById('max-energia').textContent = '-';
      document.getElementById('min-energia').textContent = '-';
      
      // Verificar si hay datos m치s antiguos para mostrar estado correcto
      try {
        const response24h = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/consumo?rango=1440`);
        const result24h = await response24h.json();
        if (result24h.datos && result24h.datos.length > 0) {
          // Hay datos m치s antiguos, mostrar como desconectado
          updateDeviceStatus('energia', true, result24h.ultima_fecha);
        } else {
          // Realmente no hay datos
          updateDeviceStatus('energia', false, null);
        }
      } catch (error) {
        console.error(`Error verificando datos antiguos de consumo:`, error);
        updateDeviceStatus('energia', false, null);
      }
    }

    // Actualizar datos de la tarjeta de tensi칩n
    const tensionData = data.tension;
    if (tensionData && tensionData.length > 0) {
      const tensionChart = new Chart(document.getElementById('preview-tension').getContext('2d'), {
        type: 'line',
        data: {
          labels: tensionData.map(d => d.tiempo),
          datasets: [{
            label: 'Tensi칩n (V)',
            data: tensionData.map(d => d.valor),
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255,193,7,0.1)',
            tension: 0.35,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              title: { display: true, text: 'Tensi칩n (V)' },
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            },
            x: {
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            }
          }
        }
      });
      document.getElementById('current-tension').textContent = tensionData[tensionData.length - 1].valor.toFixed(2);
      document.getElementById('max-tension').textContent = Math.max(...tensionData.map(d => d.valor)).toFixed(2);
      document.getElementById('min-tension').textContent = Math.min(...tensionData.map(d => d.valor)).toFixed(2);
    } else {
      document.getElementById('preview-tension').innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
          <h6 class="text-warning">Sin datos en la 칰ltima hora</h6>
          <p class="text-muted mb-2">No se han recibido mediciones de tensi칩n en la 칰ltima hora.</p>
          <small class="text-muted">Verifica que el dispositivo est칠 conectado y enviando datos.</small>
        </div>`;
      document.getElementById('current-tension').textContent = '-';
      document.getElementById('max-tension').textContent = '-';
      document.getElementById('min-tension').textContent = '-';
    }

    // Actualizar datos de la tarjeta de corriente
    const corrienteData = data.corriente;
    if (corrienteData && corrienteData.length > 0) {
      const corrienteChart = new Chart(document.getElementById('preview-corriente').getContext('2d'), {
        type: 'line',
        data: {
          labels: corrienteData.map(d => d.tiempo),
          datasets: [{
            label: 'Corriente (A)',
            data: corrienteData.map(d => d.valor),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.1)',
            tension: 0.35,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              title: { display: true, text: 'Corriente (A)' },
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            },
            x: {
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            }
          }
        }
      });
      document.getElementById('current-corriente').textContent = corrienteData[corrienteData.length - 1].valor.toFixed(2);
      document.getElementById('max-corriente').textContent = Math.max(...corrienteData.map(d => d.valor)).toFixed(2);
      document.getElementById('min-corriente').textContent = Math.min(...corrienteData.map(d => d.valor)).toFixed(2);
    } else {
      document.getElementById('preview-corriente').innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
          <h6 class="text-warning">Sin datos en la 칰ltima hora</h6>
          <p class="text-muted mb-2">No se han recibido mediciones de corriente en la 칰ltima hora.</p>
          <small class="text-muted">Verifica que el dispositivo est칠 conectado y enviando datos.</small>
        </div>`;
      document.getElementById('current-corriente').textContent = '-';
      document.getElementById('max-corriente').textContent = '-';
      document.getElementById('min-corriente').textContent = '-';
    }

    // Actualizar datos de la tarjeta de FP
    const fpData = data.fp;
    if (fpData && fpData.length > 0) {
      const fpChart = new Chart(document.getElementById('preview-fp').getContext('2d'), {
        type: 'line',
        data: {
          labels: fpData.map(d => d.tiempo),
          datasets: [{
            label: 'Factor de Potencia',
            data: fpData.map(d => d.valor),
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            tension: 0.35,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              title: { display: true, text: 'Factor de Potencia' },
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            },
            x: {
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            }
          }
        }
      });
      document.getElementById('current-fp').textContent = fpData[fpData.length - 1].valor.toFixed(2);
      document.getElementById('max-fp').textContent = Math.max(...fpData.map(d => d.valor)).toFixed(2);
      document.getElementById('min-fp').textContent = Math.min(...fpData.map(d => d.valor)).toFixed(2);
    } else {
      document.getElementById('preview-fp').innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
          <h6 class="text-warning">Sin datos en la 칰ltima hora</h6>
          <p class="text-muted mb-2">No se han recibido mediciones de factor de potencia en la 칰ltima hora.</p>
          <small class="text-muted">Verifica que el dispositivo est칠 conectado y enviando datos.</small>
        </div>`;
      document.getElementById('current-fp').textContent = '-';
      document.getElementById('max-fp').textContent = '-';
      document.getElementById('min-fp').textContent = '-';
    }

    // Actualizar datos de la tarjeta de Frecuencia
    const frecuenciaData = data.frecuencia;
    if (frecuenciaData && frecuenciaData.length > 0) {
      const frecuenciaChart = new Chart(document.getElementById('preview-frecuencia').getContext('2d'), {
        type: 'line',
        data: {
          labels: frecuenciaData.map(d => d.tiempo),
          datasets: [{
            label: 'Frecuencia (Hz)',
            data: frecuenciaData.map(d => d.valor),
            borderColor: '#0dcaf0',
            backgroundColor: 'rgba(13,202,240,0.1)',
            tension: 0.35,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              title: { display: true, text: 'Frecuencia (Hz)' },
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            },
            x: {
              grid: { color: getChartColors().grid },
              ticks: { color: getChartColors().axis }
            }
          }
        }
      });
      document.getElementById('current-frecuencia').textContent = frecuenciaData[frecuenciaData.length - 1].valor.toFixed(2);
      document.getElementById('max-frecuencia').textContent = Math.max(...frecuenciaData.map(d => d.valor)).toFixed(2);
      document.getElementById('min-frecuencia').textContent = Math.min(...frecuenciaData.map(d => d.valor)).toFixed(2);
    } else {
      document.getElementById('preview-frecuencia').innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
          <h6 class="text-warning">Sin datos en la 칰ltima hora</h6>
          <p class="text-muted mb-2">No se han recibido mediciones de frecuencia en la 칰ltima hora.</p>
          <small class="text-muted">Verifica que el dispositivo est칠 conectado y enviando datos.</small>
        </div>`;
      document.getElementById('current-frecuencia').textContent = '-';
      document.getElementById('max-frecuencia').textContent = '-';
      document.getElementById('min-frecuencia').textContent = '-';
    }

    // Actualizar estados de todos los dispositivos basado en los datos obtenidos
    const magnitudesToCheck = ['tension', 'corriente', 'fp', 'frecuencia'];
    
    for (const magnitud of magnitudesToCheck) {
      const magnitudData = data[magnitud];
      if (magnitudData && magnitudData.length > 0) {
        // Si hay datos en la 칰ltima hora, verificar si son recientes (칰ltimos 30 min)
        try {
          const response = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/${magnitud}?rango=30`);
          const result = await response.json();
          if (result.datos && result.datos.length > 0) {
            // Datos recientes (칰ltimos 30 min)
            updateDeviceStatus(magnitud, true, result.ultima_fecha);
          } else {
            // Datos antiguos (m치s de 30 min)
            const response24h = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/${magnitud}?rango=1440`);
            const result24h = await response24h.json();
            if (result24h.datos && result24h.datos.length > 0) {
              updateDeviceStatus(magnitud, true, result24h.ultima_fecha);
            } else {
              updateDeviceStatus(magnitud, false, null);
            }
          }
        } catch (error) {
          console.error(`Error obteniendo fecha de ${magnitud}:`, error);
          updateDeviceStatus(magnitud, false, null);
        }
      } else {
        // Si no hay datos en la 칰ltima hora, verificar si hay datos m치s antiguos
        try {
          const response = await fetch(`/enertrack/api/nodo/${nodoId}/magnitud/${magnitud}?rango=1440`); // 24 horas
          const result = await response.json();
          if (result.datos && result.datos.length > 0) {
            // Hay datos m치s antiguos, usar la fecha real del 칰ltimo dato
            updateDeviceStatus(magnitud, true, result.ultima_fecha);
          } else {
            updateDeviceStatus(magnitud, false, null);
          }
        } catch (error) {
          console.error(`Error verificando datos antiguos de ${magnitud}:`, error);
          updateDeviceStatus(magnitud, false, null);
        }
      }
    }

  } catch (error) {
    console.error("Error al actualizar los datos del dispositivo:", error);
    // Manejar errores de red o de servidor
  }
}

// --- Gesti칩n AJAX de umbral de consumo ---
function mostrarFeedback(msg, success=true) {
  feedbackDiv.className = 'alert ' + (success ? 'alert-success' : 'alert-danger');
  feedbackDiv.textContent = msg;
  feedbackDiv.style.display = 'block';
  setTimeout(() => { feedbackDiv.style.display = 'none'; }, 2500);
}

function cargarUmbral() {
  fetch(`/enertrack/api/umbral/${nodoId}`)
    .then(r => r.json())
    .then(data => {
      if (data.ventana_min && data.umbral_kWh) {
        ventanaMinSel.value = data.ventana_min;
        umbralKWhInput.value = data.umbral_kWh;
        btnEliminarUmbral.style.display = '';
      } else {
        ventanaMinSel.value = '15';
        umbralKWhInput.value = '';
        btnEliminarUmbral.style.display = 'none';
      }
    });
}

// --- FIX: Proteger todos los addEventListener para evitar errores de null ---
var umbralForm = document.getElementById('umbralForm');
var ventanaMinSel = document.getElementById('ventana_min');
var umbralKWhInput = document.getElementById('umbral_kWh');
var btnEliminarUmbral = document.getElementById('btnEliminarUmbral');
var feedbackDiv = document.getElementById('umbralFeedback');

if (umbralForm) {
  umbralForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const ventana_min = ventanaMinSel.value;
    const umbral_kWh = umbralKWhInput.value;
    fetch(`/enertrack/api/umbral/${nodoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ventana_min, umbral_kWh })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        mostrarFeedback('Umbral guardado correctamente.', true);
        cargarUmbral();
      } else {
        mostrarFeedback('Error al guardar el umbral.', false);
      }
    })
    .catch(() => mostrarFeedback('Error de red al guardar el umbral.', false));
  });
}

if (btnEliminarUmbral) {
  btnEliminarUmbral.addEventListener('click', function() {
    if (!confirm('쮼liminar el umbral de este nodo?')) return;
    fetch(`/enertrack/api/umbral/${nodoId}`, { method: 'DELETE' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          mostrarFeedback('Umbral eliminado.', true);
          cargarUmbral();
        } else {
          mostrarFeedback('Error al eliminar el umbral.', false);
        }
      })
      .catch(() => mostrarFeedback('Error de red al eliminar el umbral.', false));
  });
}

document.addEventListener('DOMContentLoaded', cargarUmbral);

// --- BLOQUE UNIFICADO PARA ACTUALIZAR TODAS LAS MAGNITUDES EN DASHBOARDS DE MONITOREO ---
document.addEventListener('DOMContentLoaded', async () => {
  try {
    console.log('DASHBOARDS: Haciendo fetch a /api/nodo/' + nodoId + '/latest');
    const response = await fetch(`/api/nodo/${nodoId}/latest`);
    const data = await response.json();
    console.log('DASHBOARDS: Respuesta de /api/nodo/' + nodoId + '/latest', data);
    // Magnitudes a mostrar
    const magnitudes = [
      { key: 'consumo', label: 'Consumo (kWh)', color: '#ef4444', bg: 'rgba(239,68,68,0.1)', chart: 'preview-energia', estado: 'estado-energia', last: 'last-update-energia', current: 'current-energia', max: 'max-energia', min: 'min-energia' },
      { key: 'tension', label: 'Tensi칩n (V)', color: '#ffc107', bg: 'rgba(255,193,7,0.1)', chart: 'preview-tension', estado: 'estado-tension', last: 'last-update-tension', current: 'current-tension', max: 'max-tension', min: 'min-tension' },
      { key: 'corriente', label: 'Corriente (A)', color: '#22c55e', bg: 'rgba(34,197,94,0.1)', chart: 'preview-corriente', estado: 'estado-corriente', last: 'last-update-corriente', current: 'current-corriente', max: 'max-corriente', min: 'min-corriente' },
      { key: 'fp', label: 'Factor de Potencia', color: '#2563eb', bg: 'rgba(37,99,235,0.1)', chart: 'preview-fp', estado: 'estado-fp', last: 'last-update-fp', current: 'current-fp', max: 'max-fp', min: 'min-fp' },
      { key: 'frecuencia', label: 'Frecuencia (Hz)', color: '#0dcaf0', bg: 'rgba(13,202,240,0.1)', chart: 'preview-frecuencia', estado: 'estado-frecuencia', last: 'last-update-frecuencia', current: 'current-frecuencia', max: 'max-frecuencia', min: 'min-frecuencia' }
    ];
    for (const mag of magnitudes) {
      // Estado y 칰ltima actualizaci칩n (todos usan el mismo estado/ultima_actualizacion del nodo)
      const statusElement = document.getElementById(mag.estado);
      const lastUpdateElement = document.getElementById(mag.last);
      if (data.estado === 'activo') {
        statusElement.textContent = 'Activo';
        statusElement.style.background = '#28a745';
        statusElement.style.color = '#fff';
        lastUpdateElement.innerHTML = `<i class=\"fas fa-clock me-1\"></i> 칔ltima actualizaci칩n: ${data.ultima_actualizacion ? new Date(data.ultima_actualizacion).toLocaleString('es-ES') : '-'}`;
      } else if (data.estado === 'desconectado') {
        statusElement.textContent = 'Desconectado';
        statusElement.style.background = '#dc3545';
        statusElement.style.color = '#fff';
        lastUpdateElement.innerHTML = `<i class=\"fas fa-clock me-1\"></i> 칔ltima actualizaci칩n: ${data.ultima_actualizacion ? new Date(data.ultima_actualizacion).toLocaleString('es-ES') : '-'}`;
      } else {
        statusElement.textContent = 'Sin datos';
        statusElement.style.background = '#6c757d';
        statusElement.style.color = '#fff';
        lastUpdateElement.innerHTML = `<i class=\"fas fa-clock me-1\"></i> 칔ltima actualizaci칩n: Sin datos`;
      }
      // Mini-vista previa: solo un valor, duplicar el punto
      let serie = [];
      if (data[mag.key] && data[mag.key].actual !== null && data[mag.key].timestamp) {
        serie = [{x: new Date(data[mag.key].timestamp), y: data[mag.key].actual}];
      }
      if (serie.length === 1) {
        const p = serie[0];
        serie.push({x: new Date(new Date(p.x).getTime() + 1000), y: p.y});
      }
      if (serie.length > 0) {
        const ctx = document.getElementById(mag.chart).getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: serie.map(p => p.x.toLocaleTimeString('es-ES')),
            datasets: [{
              data: serie.map(p => p.y),
              borderColor: mag.color,
              backgroundColor: mag.bg,
              tension: 0.35,
              fill: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { title: { display: true, text: mag.label }, grid: { color: getChartColors().grid }, ticks: { color: getChartColors().axis } },
              x: { grid: { color: getChartColors().grid }, ticks: { color: getChartColors().axis } }
            }
          }
        });
        // Actual, m치ximo, m칤nimo
        document.getElementById(mag.current).textContent = data[mag.key].actual !== null ? data[mag.key].actual.toFixed(2) : '-';
        document.getElementById(mag.max).textContent = data[mag.key].max !== null ? data[mag.key].max.toFixed(2) : '-';
        document.getElementById(mag.min).textContent = data[mag.key].min !== null ? data[mag.key].min.toFixed(2) : '-';
      } else {
        document.getElementById(mag.current).textContent = '-';
        document.getElementById(mag.max).textContent = '-';
        document.getElementById(mag.min).textContent = '-';
      }
    }
  } catch (e) { /* fallback: no datos */ }
});

// ---------------------- JS de inicializaci칩n ----------------------
document.addEventListener('DOMContentLoaded', () => {
  // Actualizar datos del dispositivo seleccionado (esto tambi칠n actualizar치 los estados)
  updateData(dispositivoSeleccionado);

  // Configurar intervalo de actualizaci칩n (por ejemplo, cada 5 segundos)
  setInterval(() => {
    updateData(dispositivoSeleccionado);
  }, 5000); // 5 segundos
});
</script>
{% endblock %}